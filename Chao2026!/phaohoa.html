<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hiệu ứng Pháo Hoa Canvas</title>
    <style>
        body {
            background: #000;
            margin: 0;
            overflow: hidden; /* Ẩn thanh cuộn */
        }
        canvas {
            display: block;
        }
    </style>
</head>
<body>

<canvas id="canvas"></canvas>

<script>
    // Cấu hình ban đầu
    window.requestAnimFrame = (function(){
      return  window.requestAnimationFrame       || 
              window.webkitRequestAnimationFrame || 
              window.mozRequestAnimationFrame    || 
              function( callback ){
                window.setTimeout(callback, 1000 / 60);
              };
    })();

    var canvas = document.getElementById('canvas'),
        ctx = canvas.getContext('2d'),
        cw = window.innerWidth,
        ch = window.innerHeight,
        fireworks = [],
        particles = [],
        hue = 120, // Màu sắc khởi điểm
        limiterTotal = 5,
        limiterTick = 0,
        timerTotal = 80,
        timerTick = 0,
        mousedown = false,
        mx,
        my;
        
    // Thiết lập kích thước canvas full màn hình
    canvas.width = cw;
    canvas.height = ch;

    // Hàm tiện ích: Lấy số ngẫu nhiên trong khoảng
    function random( min, max ) {
        return Math.random() * ( max - min ) + min;
    }

    // Hàm tiện ích: Tính khoảng cách giữa 2 điểm
    function calculateDistance( p1x, p1y, p2x, p2y ) {
        var xDistance = p1x - p2x,
            yDistance = p1y - p2y;
        return Math.sqrt( Math.pow( xDistance, 2 ) + Math.pow( yDistance, 2 ) );
    }

    // --- LỚP FIREWORK (Tên lửa bay lên) ---
    function Firework( sx, sy, tx, ty ) {
        // Tọa độ hiện tại
        this.x = sx;
        this.y = sy;
        // Tọa độ bắt đầu
        this.sx = sx;
        this.sy = sy;
        // Tọa độ đích
        this.tx = tx;
        this.ty = ty;
        // Khoảng cách đến đích
        this.distanceToTarget = calculateDistance( sx, sy, tx, ty );
        this.distanceTraveled = 0;
        // Theo dõi tọa độ cũ để tạo hiệu ứng đuôi (trail)
        this.coordinates = [];
        this.coordinateCount = 3;
        while( this.coordinateCount-- ) {
            this.coordinates.push( [ this.x, this.y ] );
        }
        this.angle = Math.atan2( ty - sy, tx - sx );
        this.speed = 2;
        this.acceleration = 1.05;
        this.brightness = random( 50, 70 );
        this.targetRadius = 1;
    }

    // Cập nhật trạng thái Firework
    Firework.prototype.update = function( index ) {
        // Xóa phần tử cuối, thêm phần tử mới vào đầu mảng tọa độ
        this.coordinates.pop();
        this.coordinates.unshift( [ this.x, this.y ] );

        // Tăng tốc độ
        this.speed *= this.acceleration;

        // Tính vận tốc dựa trên góc và tốc độ
        var vx = Math.cos( this.angle ) * this.speed,
            vy = Math.sin( this.angle ) * this.speed;
        
        // Tính khoảng cách đã đi
        this.distanceTraveled = calculateDistance( this.sx, this.sy, this.x + vx, this.y + vy );

        // Nếu đã đến đích (hoặc vượt quá) thì nổ
        if( this.distanceTraveled >= this.distanceToTarget ) {
            createParticles( this.tx, this.ty );
            fireworks.splice( index, 1 ); // Xóa tên lửa
        } else {
            this.x += vx;
            this.y += vy;
        }
    }

    // Vẽ Firework
    Firework.prototype.draw = function() {
        ctx.beginPath();
        // Di chuyển đến điểm cuối cùng trong mảng tọa độ (đuôi)
        ctx.moveTo( this.coordinates[ this.coordinates.length - 1 ][ 0 ], this.coordinates[ this.coordinates.length - 1 ][ 1 ] );
        ctx.lineTo( this.x, this.y );
        ctx.strokeStyle = 'hsl(' + hue + ', 100%, ' + this.brightness + '%)';
        ctx.stroke();
    }

    // --- LỚP PARTICLE (Hạt nổ ra) ---
    function Particle( x, y ) {
        this.x = x;
        this.y = y;
        this.coordinates = [];
        this.coordinateCount = 5;
        while( this.coordinateCount-- ) {
            this.coordinates.push( [ this.x, this.y ] );
        }
        // Góc ngẫu nhiên 360 độ
        this.angle = random( 0, Math.PI * 2 );
        this.speed = random( 1, 10 );
        // Ma sát (để hạt chậm dần)
        this.friction = 0.95;
        // Trọng lực (để hạt rơi xuống)
        this.gravity = 1;
        this.hue = random( hue - 50, hue + 50 );
        this.brightness = random( 50, 80 );
        this.alpha = 1;
        // Tốc độ mờ dần
        this.decay = random( 0.015, 0.03 );
    }

    Particle.prototype.update = function( index ) {
        this.coordinates.pop();
        this.coordinates.unshift( [ this.x, this.y ] );
        this.speed *= this.friction;
        this.x += Math.cos( this.angle ) * this.speed;
        this.y += Math.sin( this.angle ) * this.speed + this.gravity;
        this.alpha -= this.decay;

        // Nếu mờ hết thì xóa hạt
        if( this.alpha <= this.decay ) {
            particles.splice( index, 1 );
        }
    }

    Particle.prototype.draw = function() {
        ctx. beginPath();
        ctx.moveTo( this.coordinates[ this.coordinates.length - 1 ][ 0 ], this.coordinates[ this.coordinates.length - 1 ][ 1 ] );
        ctx.lineTo( this.x, this.y );
        ctx.strokeStyle = 'hsla(' + this.hue + ', 100%, ' + this.brightness + '%, ' + this.alpha + ')';
        ctx.stroke();
    }

    // Tạo một nhóm hạt nổ
    function createParticles( x, y ) {
        var particleCount = 30; // Số lượng hạt mỗi vụ nổ
        while( particleCount-- ) {
            particles.push( new Particle( x, y ) );
        }
    }

    // --- VÒNG LẶP CHÍNH (GAME LOOP) ---
    function loop() {
        requestAnimFrame( loop );
        
        hue += 0.5; // Thay đổi màu theo thời gian

        // Tạo hiệu ứng vệt mờ (trails) bằng cách vẽ đè lên canvas cũ với độ trong suốt
        ctx.globalCompositeOperation = 'destination-out';
        ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
        ctx.fillRect( 0, 0, cw, ch );
        ctx.globalCompositeOperation = 'lighter';

        // Xử lý và vẽ Fireworks (tên lửa bay lên)
        var i = fireworks.length;
        while( i-- ) {
            fireworks[ i ].draw();
            fireworks[ i ].update( i );
        }

        // Xử lý và vẽ Particles (hạt nổ)
        var i = particles.length;
        while( i-- ) {
            particles[ i ].draw();
            particles[ i ].update( i );
        }

        // Tự động bắn pháo hoa ngẫu nhiên
        if( timerTick >= timerTotal ) {
            if( !mousedown ) {
                // Bắn từ đáy màn hình lên vị trí ngẫu nhiên
                fireworks.push( new Firework( cw / 2, ch, random( 0, cw ), random( 0, ch / 2 ) ) );
                timerTick = 0;
            }
        } else {
            timerTick++;
        }

        // Bắn khi giữ chuột
        if( mousedown ) {
             fireworks.push( new Firework( cw / 2, ch, mx, my ) );
        }
    }

    // Xử lý sự kiện chuột
    canvas.addEventListener( 'mousemove', function( e ) {
        mx = e.pageX - canvas.offsetLeft;
        my = e.pageY - canvas.offsetTop;
    });

    canvas.addEventListener( 'mousedown', function( e ) {
        e.preventDefault();
        mousedown = true;
    });

    canvas.addEventListener( 'mouseup', function( e ) {
        e.preventDefault();
        mousedown = false;
    });

    // Chạy chương trình
    window.onload = loop;
</script>

</body>
</html>